<!DOCTYPE html>
<html>
<head>
	<title>EX</title>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<meta content="telephone=no" name="format-detection" />
	
	
    <link rel="icon" href="/favicon.ico">
  	
  	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
<div class="author-meta">
	<div class="site-title">
		<h1><a href="http://www.startexample.com">EX</a></h1>
		<h3>
			<span>生活因折腾而精彩</span>
			<span class="site-title-offset">技术因专注而精进</span>
		</h3>
	</div>
</div>
<div class="translate">
	<span class="show-text"></span>
	<input type="button" value="zh-CN" class="translate-btn" />
</div>
<div class="post">
	<div class="post-head">
		

<article class="article">
		<h3> <a href="/2016/05/21/一个月来写测试与重构的感悟/">一个月来写测试与重构的感悟</a> </h3>
		<aside class="article-meta">
			<span>时间: 2016-05-21 09:04:04 </span>
			<span class="article-tag">
			标签:
			
				
				<a href="/tags/nodejs/">nodejs</a>
			
				 · 
				<a href="/tags/测试/">测试</a>
			
			</span>
		</aside>
</article>



	</div>
	<div class="markdown-text">
		<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#32531;&#23384;&#30340;key&#10;var appKeys = &#123;&#125;;&#10;var appExists = (appId) =&#62; &#123;&#10;&#9;if(appKeys[appId])&#123;&#10;&#9;&#9;return true;&#10;&#9;&#125;else&#123;&#10;&#9;&#9;return false;&#10;&#9;&#125;&#10;&#125;;&#10;&#10;var queryAppDetail = (appId) =&#62; &#123;&#10;&#9;return Promise.resolve()&#10;&#9;.then(() &#9;&#9;=&#62; ass.query(appId))&#10;&#9;.then((result)  =&#62; ass.notFoundCheck(result))&#10;&#9;.then((result)  =&#62; ass.blockCheck(result))&#10;&#9;.then((&#123;result&#125;)=&#62; result);&#10;&#125;;&#10;&#10;var updateApp = (app) =&#62; &#123;&#10;&#9;app.requestTimes++;&#10;&#9;return Promise.resolve()&#10;&#9;.then(() =&#62; ass.persist(app);&#10;&#125;;&#10;&#10;var checkCacheFirst = (app_id, signArr, sign, redisKey) =&#62; &#123;&#10;    return Promise.resolve()&#10;    .then(() &#9;&#9; =&#62; queryAppDetail(app))&#10;    .then((app) &#9; =&#62; updateApp(app))&#10;    .then(() &#9;&#9; =&#62; ass.yieldSign(signArr, appKeys[app_id].key))&#10;    .then((destSign) =&#62; ass.signCheck(destSign, sign))&#10;    .then(() &#9;     =&#62; ass.query(&#123;&#125;, redisKey, &#39;cache&#39;))&#10;    .then((result)   =&#62; ass.cacheCheck(result));&#10;&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let cacheFlow = (app_id, signArr, sign, redisKey) =&#62; &#123;&#10;&#9;let appStore;&#10;&#9;let appKeyQueryPromise;&#10;&#9;let shouldQuery = true;&#10;&#10;&#9;if(!appKeys[app_id])&#123;&#10;&#9;&#9;appKeyQueryPromise =  Promise.resolve()&#10;&#9;&#9;.then(() &#9;   =&#62; ass.query(appId)&#10;&#9;&#9;.then((result) =&#62; ass.notFoundCheck(result))&#10;&#9;&#9;.then((result) =&#62; ass.blockCheck(result))&#10;&#9;&#9;.then((&#123;result&#125;) =&#62; &#123;&#10;&#9;&#9;&#9;shouldQuery = false;&#10;&#9;&#9;&#9;appStore = result.list[0];&#10;&#9;&#9;&#9;return Promise.resolve();&#10;&#9;&#9;&#125;);&#10;&#9;&#125;else&#123;&#10;&#9;&#9;appKeyQueryPromise = Promise.resolve();&#10;&#9;&#125;&#10;&#10;    return Promise.resolve()&#10;    .then(() =&#62; appKeyQueryPromise)&#10;    .then(() =&#62; &#123;&#10;    &#9;appKeys[app_id] = appKeys[app_id] || &#123;key: appStore.key, tactics: appStore.tactics&#125;;&#10;&#10;    &#9;Promise.resolve()&#10;    &#9;.then(() =&#62; (shouldQuery &#38;&#38; ass.query(appId)))&#10;    &#9;.then((&#123;result&#125;) =&#62; &#123;&#10;    &#9;&#9;if(shouldQuery)&#123; appStore = result.list[0]; &#125;&#10;    &#9;&#9;appStore.requestTimes++;&#10;    &#9;&#125;)&#10;    &#9;.then(() =&#62; ass.persist(app));&#10;        return Promise.resolve();&#10;    &#125;)&#10;    .then(() &#9;&#9; =&#62; ass.yieldSign(signArr, appKeys[app_id].key))&#10;    .then((destSign) =&#62; ass.signCheck(destSign, sign))&#10;    .then(() &#9;&#9; =&#62; ass.query(&#123;&#125;, redisKey, &#39;cache&#39;))&#10;    .then((result) &#9; =&#62; ass.cacheCheck(result));&#10;&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="为什么需要写测试"><a href="#为什么需要写测试" class="headerlink" title="为什么需要写测试"></a>为什么需要写测试</h1><h1 id="测试与重构的关系"><a href="#测试与重构的关系" class="headerlink" title="测试与重构的关系"></a>测试与重构的关系</h1><h1 id="单元测试实践心得"><a href="#单元测试实践心得" class="headerlink" title="单元测试实践心得"></a>单元测试实践心得</h1><p>引入被测函数的几种情况</p>
<ul>
<li>module.exports </li>
<li>rewire<br>通过问题回答测试中可能遇到的测试问题</li>
<li>测试中存在异步, 使用mocha done</li>
<li>被测函数不是单纯的函数而是多个函数的结合, mm模拟其他函数行为, 只关注当前测试函数的逻辑简化测试</li>
<li></li>
</ul>
<h1 id="重构实践心得"><a href="#重构实践心得" class="headerlink" title="重构实践心得"></a>重构实践心得</h1><h1 id="测试与重构中遇到的问题"><a href="#测试与重构中遇到的问题" class="headerlink" title="测试与重构中遇到的问题"></a>测试与重构中遇到的问题</h1><h1 id="关于重构书籍"><a href="#关于重构书籍" class="headerlink" title="关于重构书籍"></a>关于重构书籍</h1><h2 id="关于-lt-lt-编写可读代码的艺术-gt-gt"><a href="#关于-lt-lt-编写可读代码的艺术-gt-gt" class="headerlink" title="关于&lt;&lt;编写可读代码的艺术&gt;&gt;"></a>关于&lt;&lt;编写可读代码的艺术&gt;&gt;</h2><h2 id="关于-lt-lt-重构-改善既有代码设计-gt-gt"><a href="#关于-lt-lt-重构-改善既有代码设计-gt-gt" class="headerlink" title="关于&lt;&lt;重构, 改善既有代码设计&gt;&gt;"></a>关于&lt;&lt;重构, 改善既有代码设计&gt;&gt;</h2>
	</div>
</div>
<script src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js" type="text/javascript"></script>
<script src="/js/translate.js" type="text/javascript"></script>

<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76506889-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>