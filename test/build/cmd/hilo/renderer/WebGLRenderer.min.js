/**
 * Hilo 1.0.1 for cmd
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
define(function(t,e,r){var i=t("hilo/core/Class"),a=t("hilo/renderer/Renderer"),n=t("hilo/geom/Matrix"),s=Math.PI/180,o=i.create({Extends:a,Statics:{MAX_BATCH_NUM:2e3,ATTRIBUTE_NUM:5,isSupport:function(){if(void 0==this._isSupported){var t=document.createElement("canvas");t.getContext&&(t.getContext("webgl")||t.getContext("experimental-webgl"))?this._isSupported=!0:this._isSupported=!1}return this._isSupported}},renderType:"webgl",gl:null,_isContextLost:!1,_cacheTexture:{},constructor:function(t){o.superclass.constructor.call(this,t);var e=this;this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");this.maxBatchNum=o.MAX_BATCH_NUM,this.positionStride=4*o.ATTRIBUTE_NUM;var r=this.maxBatchNum*o.ATTRIBUTE_NUM*4,i=6*this.maxBatchNum;this.arrayBuffer=new ArrayBuffer(4*r),this.float32Array=new Float32Array(this.arrayBuffer),this.uint32Array=new Uint32Array(this.arrayBuffer),this.indexs=new Uint16Array(i);for(var a=0,n=0;a<i;a+=6,n+=4)this.indexs[a+0]=n+0,this.indexs[a+1]=n+1,this.indexs[a+2]=n+2,this.indexs[a+3]=n+1,this.indexs[a+4]=n+2,this.indexs[a+5]=n+3;this.batchIndex=0,this.sprites=[],this.canvas.addEventListener("webglcontextlost",function(t){e._isContextLost=!0,t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",function(t){e._isContextLost=!1,e.setupWebGLStateAndResource()},!1),this.setupWebGLStateAndResource()},setupWebGLStateAndResource:function(){var t=this.gl;t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.enable(t.BLEND),this._cacheTexture={},this._initShaders(),this.defaultShader.active(),this.positionBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indexs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this.arrayBuffer,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.a_position,2,t.FLOAT,!1,this.positionStride,0),t.vertexAttribPointer(this.a_TexCoord,2,t.FLOAT,!1,this.positionStride,8),t.vertexAttribPointer(this.a_tint,4,t.UNSIGNED_BYTE,!0,this.positionStride,16)},context:null,startDraw:function(t){return!!(t.visible&&t.alpha>0)&&(t===this.stage&&this.clear(),!0)},draw:function(t){var e=(this.context,t.width),r=t.height,i=(t.background,t.drawable),a=i&&i.image;if(a){var n=(this.gl,i.rect),s=n[2],o=n[3];n[4],n[5];e||r||(e=t.width=s,r=t.height=o),this.batchIndex>=this.maxBatchNum&&this._renderBatches();var h=this._createVertexs(a,n[0],n[1],s,o,0,0,e,r),c=this.batchIndex*this.positionStride,_=this.float32Array,l=this.uint32Array,d=(t.tint>>16)+(65280&t.tint)+((255&t.tint)<<16)+(255*t.__webglRenderAlpha<<24);_[c+0]=h[0],_[c+1]=h[1],_[c+2]=h[2],_[c+3]=h[3],l[c+4]=d,_[c+5]=h[4],_[c+6]=h[5],_[c+7]=h[6],_[c+8]=h[7],l[c+9]=d,_[c+10]=h[8],_[c+11]=h[9],_[c+12]=h[10],_[c+13]=h[11],l[c+14]=d,_[c+15]=h[12],_[c+16]=h[13],_[c+17]=h[14],_[c+18]=h[15],l[c+19]=d;for(var u=t.__webglWorldMatrix,f=0;f<4;f++){var g=_[c+5*f],x=_[c+5*f+1];_[c+5*f]=u.a*g+u.c*x+u.tx,_[c+5*f+1]=u.b*g+u.d*x+u.ty}t.__textureImage=a,this.sprites[this.batchIndex++]=t}},endDraw:function(t){t===this.stage&&this._renderBatches()},transform:function(t){var e=t.drawable;if(e&&e.domElement)return void Hilo.setElementStyleByView(t);var r=(this.context,t.scaleX),i=t.scaleY;if(t===this.stage){var a=this.canvas.style,s=t._scaleX,o=t._scaleY,h=!1;(!s&&1!=r||s&&s!=r)&&(t._scaleX=r,a.width=r*t.width+"px",h=!0),(!o&&1!=i||o&&o!=i)&&(t._scaleY=i,a.height=i*t.height+"px",h=!0),h&&t.updateViewport(),t.__webglWorldMatrix=t.__webglWorldMatrix||new n(1,0,0,1,0,0)}else t.parent&&(t.__webglWorldMatrix=t.__webglWorldMatrix||new n(1,0,0,1,0,0),this._setConcatenatedMatrix(t,t.parent));t.alpha>0&&(t.parent&&t.parent.__webglRenderAlpha?t.__webglRenderAlpha=t.alpha*t.parent.__webglRenderAlpha:t.__webglRenderAlpha=t.alpha)},remove:function(t){var e=t.drawable,r=e&&e.domElement;if(r){var i=r.parentNode;i&&i.removeChild(r)}},clear:function(t,e,r,i){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},resize:function(t,e){if(this.width!==t||this.height!==e){var r=this.canvas,i=this.stage,a=r.style;this.width=r.width=t,this.height=r.height=e,a.width=i.width*i.scaleX+"px",a.height=i.height*i.scaleY+"px",this.gl.viewport(0,0,t,e),this.canvasHalfWidth=.5*t,this.canvasHalfHeight=.5*e,this._uploadProjectionTransform(!0)}},_renderBatches:function(){var t=this.gl;t.bufferSubData(t.ARRAY_BUFFER,0,this.uint32Array.subarray(0,this.batchIndex*this.positionStride));for(var e=0,r=0,i=null,a=0;a<this.batchIndex;a++){var n=this.sprites[a];i&&i!==n.__textureImage&&(this._renderBatch(e,a),e=a,r=1),i=n.__textureImage}this._renderBatch(e,this.batchIndex),this.batchIndex=0},_renderBatch:function(t,e){var r=this.gl,i=e-t;i>0&&(r.bindTexture(r.TEXTURE_2D,this._getTexture(this.sprites[t])),r.drawElements(r.TRIANGLES,6*i,r.UNSIGNED_SHORT,6*t*2))},_uploadProjectionTransform:function(t){this._projectionTransformElements&&!t||(this._projectionTransformElements=new Float32Array([1/this.canvasHalfWidth,0,0,0,-1/this.canvasHalfHeight,0,-1,1,1])),this.gl.uniformMatrix3fv(this.u_projectionTransform,!1,this._projectionTransformElements)},_initShaders:function(){var t="            attribute vec2 a_position;\n            attribute vec2 a_TexCoord;\n            attribute vec4 a_tint;\n            uniform mat3 u_projectionTransform;\n            varying vec2 v_TexCoord;\n            varying vec4 v_tint;\n            void main(){\n                gl_Position =  vec4((u_projectionTransform * vec3(a_position, 1.0)).xy, 1.0, 1.0);\n                v_TexCoord = a_TexCoord;\n                v_tint = vec4(a_tint.rgb * a_tint.a, a_tint.a);\n            }\n        ",e="\n            precision mediump float;\n            uniform sampler2D u_Sampler;\n            varying vec2 v_TexCoord;\n            varying vec4 v_tint;\n            void main(){\n                gl_FragColor = texture2D(u_Sampler, v_TexCoord) * v_tint;\n            }\n        ";this.defaultShader=new h(this,{v:t,f:e},{attributes:["a_position","a_TexCoord","a_tint"],uniforms:["u_projectionTransform","u_Sampler"]})},_createVertexs:function(t,e,r,i,a,n,s,o,h){var c=this.__tempVertexs||[],_=t.width,l=t.height;i/=_,a/=l,e/=_,r/=l,o=o,h=h,n=n,s=s,i+e>1&&(i=1-e),a+r>1&&(a=1-r);var d=0;return c[d++]=n,c[d++]=s,c[d++]=e,c[d++]=r,c[d++]=n+o,c[d++]=s,c[d++]=e+i,c[d++]=r,c[d++]=n,c[d++]=s+h,c[d++]=e,c[d++]=r+a,c[d++]=n+o,c[d++]=s+h,c[d++]=e+i,c[d++]=r+a,c},_setConcatenatedMatrix:function(t,e){var r=t.__webglWorldMatrix,i=1,a=0,n=t.rotation%360,o=t.pivotX,h=t.pivotY,c=t.scaleX,_=t.scaleY;if(n){var l=n*s;i=Math.cos(l),a=Math.sin(l)}r.a=i*c,r.b=a*c,r.c=-a*_,r.d=i*_,r.tx=t.x-r.a*o-r.c*h,r.ty=t.y-r.b*o-r.d*h,r.concat(e.__webglWorldMatrix)},_getTexture:function(t){var e=t.__textureImage,r=this._cacheTexture[e.src];return r||(r=this.activeShader.uploadTexture(e)),r}}),h=function(t,e,r){this.renderer=t,this.gl=t.gl,this.program=this._createProgram(this.gl,e.v,e.f),r=r||{},this.attributes=r.attributes||[],this.uniforms=r.uniforms||[]};return h.prototype={active:function(){var t=this,e=t.renderer,r=t.gl,i=t.program;i&&r&&(e.activeShader=t,r.useProgram(i),t.attributes.forEach(function(t){e[t]=r.getAttribLocation(i,t),r.enableVertexAttribArray(e[t])}),t.uniforms.forEach(function(t){e[t]=r.getUniformLocation(i,t)}),t.width===e.width&&t.height===e.height||(t.width=e.width,t.height=e.height,e._uploadProjectionTransform()))},uploadTexture:function(t){var e=this.gl,r=this.renderer,i=e.createTexture(),a=r.u_Sampler;return e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.uniform1i(a,0),e.bindTexture(e.TEXTURE_2D,null),this.renderer._cacheTexture[t.src]=i,i},_createProgram:function(t,e,r){var i=this._createShader(t,t.VERTEX_SHADER,e),a=this._createShader(t,t.FRAGMENT_SHADER,r);if(!i||!a)return null;var n=t.createProgram();if(n){t.attachShader(n,i),t.attachShader(n,a),t.linkProgram(n),t.deleteShader(a),t.deleteShader(i);var s=t.getProgramParameter(n,t.LINK_STATUS);if(!s){var o=t.getProgramInfoLog(n);return console.log("Failed to link program: "+o),t.deleteProgram(n),null}}return n},_createShader:function(t,e,r){var i=t.createShader(e);if(i){t.shaderSource(i,r),t.compileShader(i);var a=t.getShaderParameter(i,t.COMPILE_STATUS);if(!a){var n=t.getShaderInfoLog(i);return console.log("Failed to compile shader: "+n),t.deleteShader(i),null}}return i}},o});